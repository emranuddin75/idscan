{"version":3,"file":"ides-micro.min.js","mappings":"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","sources":["webpack://GBG.Idscan/webpack/universalModuleDefinition","webpack://GBG.Idscan/./src/ides/enums/messages.ts","webpack://GBG.Idscan/webpack/bootstrap","webpack://GBG.Idscan/./src/ides/worker.ts"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"GBG\"] = factory();\n\telse\n\t\troot[\"GBG\"] = root[\"GBG\"] || {}, root[\"GBG\"][\"Idscan\"] = factory();\n})(this, () => {\nreturn ","/**\r\n * @public\r\n */\r\nexport enum IdesMicroWorkerMessages {\r\n\tCheckComplete = 'CheckComplete',\r\n\tCheckFailed = 'CheckFailed',\r\n\tInitialise = 'Initialise',\r\n\tTerminate = 'Terminate',\r\n\tLoadingResources = 'LoadingResources',\r\n\tPerformQualityCheck = 'PerformQualityCheck',\r\n\tReadyToProcess = 'ReadyToProcess',\r\n\tError = 'Error',\r\n}\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","import { IdesMicroWorkerMessages } from './enums/messages';\r\nimport { IWorkerMessageEvent, IWorkerMessage, IImageCoordinates } from './interfaces/message';\r\n\r\nexport class IdesMicroWorker {\r\n\r\n\tprivate idesMicro?: any;\r\n\tprivate workerGlobalContext: any;\r\n\tprivate frameSelection: any;\r\n\r\n\tprivate timeLogsEnabled?: boolean;\r\n\r\n\tconstructor(workerGlobalContext: any) {\r\n\t\tthis.workerGlobalContext = workerGlobalContext;\r\n\r\n\t\tthis.workerGlobalContext.addEventListener('message', this.onMessage);\r\n\t\tthis.workerGlobalContext.addEventListener('error', this.onError);\r\n\t}\r\n\r\n\tprivate postMessage = (id: string, message: IdesMicroWorkerMessages, data?: any): Promise<void> => new Promise((resolve) => {\r\n\t\treturn resolve(this.workerGlobalContext.postMessage({ id, message, data } as IWorkerMessage));\r\n\t})\r\n\r\n\tprivate onError = (e: Error) => this.postMessage('', IdesMicroWorkerMessages.Error, { ...e });\r\n\r\n\tprivate onMessage = ({ data }: IWorkerMessageEvent) => {\r\n\t\tswitch (data.message) {\r\n\t\t\tcase IdesMicroWorkerMessages.PerformQualityCheck:\r\n\t\t\t\treturn this.onPerformQualityCheck(data.id, data.data);\r\n\t\t\tcase IdesMicroWorkerMessages.Terminate:\r\n\t\t\t\treturn this.postMessage(data.id, IdesMicroWorkerMessages.Terminate)\r\n\t\t\t\t\t.then(() => this.workerGlobalContext.close());\r\n\t\t\tcase IdesMicroWorkerMessages.Initialise:\r\n\t\t\t\treturn this.onInitialise(data.data.asmScriptUrl, data.data.timeout, data.data.timeLogsEnabled)\r\n\t\t\t\t\t.then(() => this.postMessage(data.id, IdesMicroWorkerMessages.ReadyToProcess))\r\n\t\t\t\t\t.catch(() => this.postMessage(data.id, IdesMicroWorkerMessages.Error));\r\n\t\t\tdefault:\r\n\t\t\t// Do Nothing\r\n\t\t}\r\n\t}\r\n\r\n\tprivate onInitialise = (asmScriptUrl: string = './idesmicro_asm.js', timeout: number = 60000, timeLogsEnabled: boolean = false) => new Promise<void>((resolve, reject) => {\r\n\t\tvar startTime = performance.now();\r\n\r\n\t\tthis.timeLogsEnabled = timeLogsEnabled;\r\n\t\tif (this.timeLogsEnabled)\r\n\t\t\tconsole.log('smart capture time logs enabled: ' + timeLogsEnabled);\r\n\r\n\t\tif (this.idesMicro) {\r\n\t\t\tvar endTime = performance.now();\r\n\t\t\tif (timeLogsEnabled)\r\n\t\t\t\tconsole.log(`IDES worker onInitialise method took: ${endTime - startTime} miliseconds`);\r\n\t\t\treturn resolve();\r\n\t\t} else {\r\n\t\t\tthis.workerGlobalContext.importScripts(asmScriptUrl);\r\n\r\n\t\t\tconst readyTimeout = setTimeout(() => reject(), timeout);\r\n\r\n\t\t\treturn this.workerGlobalContext.Initidesmicro()\r\n\t\t\t\t.then((idesMicro: any) => {\r\n\t\t\t\t\tclearTimeout(readyTimeout);\r\n\r\n\t\t\t\t\tthis.idesMicro = idesMicro;\r\n\t\t\t\t\tthis.frameSelection = new this.idesMicro.frame_selection();\r\n\r\n\t\t\t\t\tvar endTime = performance.now();\r\n\t\t\t\t\tif (timeLogsEnabled)\r\n\t\t\t\t\t\tconsole.log(`IDES worker onInitialise method took: ${endTime - startTime} miliseconds`);\r\n\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t});\r\n\t\t}\r\n\r\n\t})\r\n\r\n\tprivate onPerformQualityCheck = (id: string, { image }: { image: Uint8Array }) => {\r\n\t\tvar startTime = performance.now();\r\n\r\n\t\treturn this.checkQuality(image)\r\n\t\t\t.then((response) => this.postMessage(id, IdesMicroWorkerMessages.CheckComplete, response)).then(() => {\r\n\t\t\t\tvar endTime = performance.now();\r\n\t\t\t\tif (this.timeLogsEnabled)\r\n\t\t\t\t\tconsole.log(`| onPerformQualityCheck method took: ${endTime - startTime} ms |`);\r\n\t\t\t})\r\n\t\t\t.catch((e: any) => this.postMessage(id, IdesMicroWorkerMessages.CheckFailed, e.message));\r\n\t}\r\n\r\n\tprivate checkQuality = (imageData: Uint8Array) =>\r\n\t\tthis.checkImageQuality(imageData)\r\n\t\t\t.then(({ glare, blur, low_res, out_of_frame, document, done }) => {\r\n\t\t\t\tvar startTime = performance.now();\r\n\r\n\t\t\t\tif (done) {\r\n\t\t\t\t\tconst best_frame = this.frameSelection.get_best_frame();\r\n\t\t\t\t\tconst imageData = new Uint8Array(this.idesMicro.HEAPU8.buffer, best_frame.bufferPointerAddress, best_frame.size);\r\n\t\t\t\t\tconst resultImage = new Uint8Array(imageData);\r\n\r\n\t\t\t\t\tthis.frameSelection.clear();\r\n\r\n\t\t\t\t\tvar doneResolveResult = Promise.resolve({\r\n\t\t\t\t\t\tquality: {\r\n\t\t\t\t\t\t\tblurCheck: true,\r\n\t\t\t\t\t\t\tglareCheck: true,\r\n\t\t\t\t\t\t\tresolutionCheck: true,\r\n\t\t\t\t\t\t\tcoordinateCheck: true\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tcoords: [],\r\n\t\t\t\t\t\timage: resultImage\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tvar endTime = performance.now();\r\n\t\t\t\t\tif (this.timeLogsEnabled)\r\n\t\t\t\t\t\tconsole.log(`| checkQuality method took: ${endTime - startTime} ms |`);\r\n\r\n\t\t\t\t\treturn doneResolveResult;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvar notDoneResolveResult = Promise.resolve({\r\n\t\t\t\t\t\tquality: {\r\n\t\t\t\t\t\t\tblurCheck: !blur,\r\n\t\t\t\t\t\t\tglareCheck: !glare,\r\n\t\t\t\t\t\t\tresolutionCheck: !low_res,\r\n\t\t\t\t\t\t\tcoordinateCheck: !out_of_frame && document\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tcoords: []\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tvar endTime = performance.now();\r\n\t\t\t\t\tif (this.timeLogsEnabled)\r\n\t\t\t\t\t\tconsole.log(`| checkQuality method took: ${endTime - startTime} ms |`);\r\n\r\n\t\t\t\t\treturn notDoneResolveResult;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\tprivate checkImageQuality = (imageData: Uint8Array): Promise<{ glare: boolean, blur: boolean, low_res: boolean, out_of_frame: boolean, document: boolean, done: boolean }> =>\r\n\t\tnew Promise((resolve) => {\r\n\t\t\tvar startTime = performance.now();\r\n\r\n\t\t\tconst numBytes = imageData.length | imageData.BYTES_PER_ELEMENT;\r\n\t\t\tconst dataPtr = this.idesMicro._malloc(numBytes);\r\n\t\t\tconst dataOnHeap = new Uint8Array(this.idesMicro.HEAPU8.buffer, dataPtr, numBytes);\r\n\r\n\t\t\tdataOnHeap.set(imageData);\r\n\r\n\t\t\tvar addFrameStartTime = performance.now();\r\n\t\t\tconst response = this.frameSelection.add_frame(dataOnHeap.byteOffset, imageData.length);\r\n\t\t\tvar endTime = performance.now();\r\n\t\t\tif (this.timeLogsEnabled)\r\n\t\t\t\tconsole.log(`| add_frame method took: ${endTime - addFrameStartTime} ms |`);\r\n\r\n\t\t\tthis.idesMicro._free(dataPtr);\r\n\r\n\t\t\tif (response === undefined) {\r\n\t\t\t\treturn resolve({ glare: false, blur: false, low_res: false, out_of_frame: false, document: false, done: false });\r\n\t\t\t}\r\n\r\n\t\t\tendTime = performance.now();\r\n\t\t\tif (this.timeLogsEnabled)\r\n\t\t\t\tconsole.log(`| checkImageQuality method took: ${endTime - startTime} ms |`);\r\n\r\n\t\t\treturn resolve(response);\r\n\t\t})\r\n}\r\n\r\nexport default new IdesMicroWorker(self);\r\n"],"names":["root","factory","exports","module","define","amd","this","IdesMicroWorkerMessages","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","IdesMicroWorker","constructor","workerGlobalContext","postMessage","id","message","data","Promise","resolve","onError","e","Error","onMessage","PerformQualityCheck","onPerformQualityCheck","Terminate","then","close","Initialise","onInitialise","asmScriptUrl","timeout","timeLogsEnabled","ReadyToProcess","catch","reject","performance","now","idesMicro","importScripts","readyTimeout","setTimeout","Initidesmicro","clearTimeout","frameSelection","frame_selection","image","checkQuality","response","CheckComplete","CheckFailed","imageData","checkImageQuality","glare","blur","low_res","out_of_frame","document","done","best_frame","get_best_frame","Uint8Array","HEAPU8","buffer","bufferPointerAddress","size","resultImage","clear","doneResolveResult","quality","blurCheck","glareCheck","resolutionCheck","coordinateCheck","coords","notDoneResolveResult","numBytes","length","BYTES_PER_ELEMENT","dataPtr","_malloc","dataOnHeap","set","add_frame","byteOffset","_free","addEventListener","self"],"sourceRoot":""}